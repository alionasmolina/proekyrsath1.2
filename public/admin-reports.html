<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –æ—Ç—á–µ—Ç—ã - –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è Nadista</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: #333;
            padding: 20px;
        }

        .reports-header {
            background-color: #2c1a00;
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
            border-radius: 10px;
        }

        .reports-container {
            width: 90%;
            max-width: 1400px;
            margin: 0 auto;
        }

        .reports-logo {
            font-size: 28px;
            font-weight: bold;
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .reports-nav {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .reports-nav a {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 5px;
            transition: background-color 0.3s;
            white-space: nowrap;
        }

        .reports-nav a:hover {
            background-color: #d4af37;
            color: #2c1a00;
        }

        .reports-section {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .section-title {
            font-size: 24px;
            margin-bottom: 20px;
            color: #2c1a00;
            border-bottom: 2px solid #d4af37;
            padding-bottom: 10px;
        }

        .report-category {
            margin-bottom: 30px;
        }

        .category-title {
            font-size: 20px;
            color: #2c1a00;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }

        .report-types {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .report-type {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .report-type:hover {
            border-color: #d4af37;
            box-shadow: 0 2px 8px rgba(212, 175, 55, 0.2);
        }

        .report-type.active {
            border-color: #d4af37;
            background: #fef9e7;
        }

        .report-type h4 {
            color: #2c1a00;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .report-type p {
            color: #666;
            font-size: 14px;
            line-height: 1.4;
        }

        .report-params {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c1a00;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-control:focus {
            outline: none;
            border-color: #d4af37;
            box-shadow: 0 0 5px rgba(212, 175, 55, 0.3);
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background-color: #d4af37;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: #c19b2a;
        }

        .btn-success {
            background-color: #28a745;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background-color: #218838;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤ */
        .report-results {
            margin-top: 20px;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }

        .report-table th,
        .report-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .report-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c1a00;
        }

        .report-summary {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .summary-item {
            display: inline-block;
            margin-right: 30px;
            font-weight: 500;
        }

        .summary-value {
            font-size: 1.2em;
            color: #28a745;
            font-weight: 600;
        }

        .kpi-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .kpi-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #d4af37;
        }

        .kpi-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c1a00;
            margin: 10px 0;
        }

        .kpi-label {
            color: #666;
            font-size: 14px;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .chart-placeholder {
            height: 300px;
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 16px;
        }

        .percentage-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }

        .percentage-up {
            background: #d4edda;
            color: #155724;
        }

        .percentage-down {
            background: #f8d7da;
            color: #721c24;
        }

        /* –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        #alert-container {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            width: auto;
            max-width: 90%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .alert {
            padding: 15px 25px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 16px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 300px;
            max-width: 500px;
            border: 1px solid;
        }

        .alert-success {
            background-color: #e8f4fd;
            color: #2c1a00;
            border-color: #3498db;
        }

        .alert-error {
            background-color: #fdeaea;
            color: #c0392b;
            border-color: #e74c3c;
        }

        .alert-close {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            margin-left: 15px;
            color: inherit;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #d4af37;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .hidden {
            display: none;
        }

        .form-actions {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 10px;
            }

            .summary-item {
                display: block;
                margin-right: 0;
                margin-bottom: 10px;
            }

            .alert {
                min-width: 250px;
                padding: 12px 20px;
                font-size: 14px;
            }

            .report-types {
                grid-template-columns: 1fr;
            }

            .reports-nav {
                flex-direction: column;
                align-items: flex-start;
            }

            .form-actions {
                flex-direction: column;
            }

            .form-actions .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>

<body>
    <header class="reports-header">
        <div class="reports-container">
            <div class="reports-logo">
                <i class="fas fa-chart-line"></i>
                <span>–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –æ—Ç—á–µ—Ç—ã - Nadista's Lab Berry</span>
            </div>
            <nav class="reports-nav">
                <a href="/admin.html" target="_blank">
                    <i class="fas fa-cog"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞–º–∏
                </a>
                <a href="#" id="refresh-reports">
                    <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å
                </a>
                
                <a href="#" id="logout-btn">
                    <i class="fas fa-sign-out-alt"></i> –í—ã–π—Ç–∏
                </a>
            </nav>
        </div>
    </header>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
    <div id="alert-container"></div>

    <main class="reports-container">
        <div class="reports-section">
            <h2 class="section-title">–°–∏—Å—Ç–µ–º–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã—Ö –æ—Ç—á–µ—Ç–æ–≤</h2>

            <!-- –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –æ—Ç—á–µ—Ç—ã -->
            <div class="report-category">
                <h3 class="category-title">
                    <i class="fas fa-money-bill-wave"></i> –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –æ—Ç—á–µ—Ç—ã
                </h3>
                <div class="report-types">
                    <div class="report-type" data-report="daily-revenue">
                        <h4><i class="fas fa-calendar-day"></i> –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç—á–µ—Ç –æ –≤—ã—Ä—É—á–∫–µ</h4>
                        <p>–û–±—â–∞—è —Å—É–º–º–∞ –≤—ã—Ä—É—á–∫–∏ –∑–∞ –¥–µ–Ω—å, –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ —Ç–æ–≤–∞—Ä–Ω—ã–º –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö –µ–¥–∏–Ω–∏—Ü
                        </p>
                    </div>
                    <div class="report-type" data-report="average-check">
                        <h4><i class="fas fa-calculator"></i> –ê–Ω–∞–ª–∏–∑ —Å—Ä–µ–¥–Ω–µ–≥–æ —á–µ–∫–∞</h4>
                        <p>–°—Ä–µ–¥–Ω–∏–π —á–µ–∫ –∑–∞ –ø–µ—Ä–∏–æ–¥, –¥–∏–Ω–∞–º–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è, —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º–∏ –ø–µ—Ä–∏–æ–¥–∞–º–∏</p>
                    </div>
                    <div class="report-type" data-report="sales-dynamics">
                        <h4><i class="fas fa-chart-line"></i> –î–∏–Ω–∞–º–∏–∫–∞ –ø—Ä–æ–¥–∞–∂</h4>
                        <p>–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤ –∑–∞ –ø–µ—Ä–∏–æ–¥, —Å–µ–∑–æ–Ω–Ω—ã–µ —Ç—Ä–µ–Ω–¥—ã, –ø–∏–∫–æ–≤—ã–µ –ø–µ—Ä–∏–æ–¥—ã</p>
                    </div>
                </div>
            </div>

            <!-- –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –æ—Ç—á–µ—Ç—ã -->
            <div class="report-category">
                <h3 class="category-title">
                    <i class="fas fa-cogs"></i> –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –æ—Ç—á–µ—Ç—ã
                </h3>
                <div class="report-types">
                    <div class="report-type" data-report="order-performance">
                        <h4><i class="fas fa-clipboard-check"></i> –û—Ç—á–µ—Ç –ø–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º –∑–∞–∫–∞–∑–∞–º</h4>
                        <p>–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–∏–Ω—è—Ç—ã—Ö, –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö, –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –∏ –æ—Ç–º–µ–Ω–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</p>
                    </div>
                </div>
            </div>

            <!-- –û—Ç—á–µ—Ç—ã –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º -->
            <div class="report-category">
                <h3 class="category-title">
                    <i class="fas fa-users"></i> –û—Ç—á–µ—Ç—ã –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º
                </h3>
                <div class="report-types">
                    <div class="report-type" data-report="customer-base">
                        <h4><i class="fas fa-database"></i> –ë–∞–∑–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤</h4>
                        <p>–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤, –Ω–æ–≤—ã–µ –∫–ª–∏–µ–Ω—Ç—ã –∑–∞ –ø–µ—Ä–∏–æ–¥, –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –±–∞–∑—ã</p>
                    </div>
                    <div class="report-type" data-report="customer-orders">
                        <h4><i class="fas fa-history"></i> –ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤ –∫–ª–∏–µ–Ω—Ç–æ–≤</h4>
                        <p>–ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö –∑–∞–∫–∞–∑–æ–≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞, –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è, —á–∞—Å—Ç–æ—Ç–∞ –∑–∞–∫–∞–∑–æ–≤</p>
                    </div>
                </div>
            </div>

            <!-- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ—Ç—á–µ—Ç–∞ -->
            <div class="report-params hidden" id="report-params">
                <h4>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ—Ç—á–µ—Ç–∞</h4>
                <div class="form-row" id="common-params">
                    <div class="form-group">
                        <label for="start-date">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:</label>
                        <input type="date" id="start-date" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="end-date">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è:</label>
                        <input type="date" id="end-date" class="form-control">
                    </div>
                </div>

                <!-- –°–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –æ—Ç—á–µ—Ç–∞ -->
                <div class="form-row hidden" id="daily-revenue-params">
                    <div class="form-group">
                        <label for="report-date">–î–∞—Ç–∞ –æ—Ç—á–µ—Ç–∞:</label>
                        <input type="date" id="report-date" class="form-control">
                    </div>
                </div>

                <div class="form-row hidden" id="average-check-params">
                    <div class="form-group">
                        <label for="period-type">–¢–∏–ø –ø–µ—Ä–∏–æ–¥–∞:</label>
                        <select id="period-type" class="form-control">
                            <option value="day">–ü–æ –¥–Ω—è–º</option>
                            <option value="week">–ü–æ –Ω–µ–¥–µ–ª—è–º</option>
                            <option value="month">–ü–æ –º–µ—Å—è—Ü–∞–º</option>
                        </select>
                    </div>
                </div>

                <div class="form-row" id="customer-orders-params"
                    style="display: none; border: 2px solid #d4af37; padding: 15px; border-radius: 8px; background: #fef9e7;">
                    <div class="form-group" style="flex: 2;">
                        <label for="customer-select" style="font-weight: bold; color: #2c1a00;">–í—ã–±–µ—Ä–∏—Ç–µ
                            –∫–ª–∏–µ–Ω—Ç–∞:</label>
                        <select id="customer-select" class="form-control"
                            style="border: 1px solid #d4af37; padding: 10px;">
                            <option value="">–°–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å...</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1; display: flex; align-items: flex-end;">
                        <button type="button" id="load-customers-btn" class="btn btn-primary"
                            style="width: 100%; height: 42px;">
                            <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫
                        </button>
                    </div>
                </div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π —Å –æ—Ç—á–µ—Ç–∞–º–∏ -->
            <div class="form-actions">
                <button id="generate-report" class="btn btn-primary" disabled>
                    <i class="fas fa-chart-bar"></i> –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç
                </button>
                <button id="export-excel" class="btn btn-success" disabled>
                    <i class="fas fa-file-excel"></i> –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
                </button>
            </div>

            <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Ç—á–µ—Ç–∞ -->
            <div id="report-results" class="report-results">
                <div style="text-align: center; padding: 60px; color: #6c757d;">
                    <i class="fas fa-chart-pie" style="font-size: 64px; margin-bottom: 20px; opacity: 0.5;"></i>
                    <h3 style="margin-bottom: 10px;">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ—Ç—á–µ—Ç–∞ –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã</h3>
                    <p>–°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ, –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –æ—Ç—á–µ—Ç—ã –∏ –æ—Ç—á–µ—Ç—ã –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º</p>
                </div>
            </div>
        </div>
    </main>

    <script>
        let currentUser = null;
        let currentReportData = null;
        let currentReportType = null;

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
        function checkAuth() {
            const token = localStorage.getItem('token');
            const user = JSON.parse(localStorage.getItem('user') || 'null');

            if (!token || !user || user.role !== 'admin') {
                window.location.href = '/';
                return false;
            }

            currentUser = user;
            return true;
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `
                ${message}
                <button class="alert-close" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;
            alertContainer.appendChild(alert);

            setTimeout(() => {
                if (alert.parentElement) {
                    alert.remove();
                }
            }, 5000);
        }

        // –ì–ê–†–ê–ù–¢–ò–†–û–í–ê–ù–ù–ê–Ø –∑–∞–≥—Ä—É–∑–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤
        async function loadCustomers() {
            console.log('üöÄ –ù–∞—á–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤...');

            const select = document.getElementById('customer-select');
            const loadBtn = document.getElementById('load-customers-btn');
            const originalText = loadBtn.innerHTML;

            try {
                loadBtn.innerHTML = '<div class="loading"></div> –ó–∞–≥—Ä—É–∑–∫–∞...';
                loadBtn.disabled = true;

                const token = localStorage.getItem('token');
                console.log('–¢–æ–∫–µ–Ω:', token ? '–ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç' : '–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç');

                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π endpoint
                const response = await fetch('/api/admin/all-customers', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log('üì° –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('üìä –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ:', data);

                if (data.success && data.customers && data.customers.length > 0) {
                    select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞</option>';

                    data.customers.forEach(customer => {
                        const option = document.createElement('option');
                        option.value = customer.id;
                        const firstName = customer.first_name || '';
                        const lastName = customer.last_name || '';
                        const fullName = `${firstName} ${lastName}`.trim();
                        const displayName = fullName || `–ö–ª–∏–µ–Ω—Ç #${customer.id}`;
                        option.textContent = `${displayName} - ${customer.email}`;
                        select.appendChild(option);
                    });

                    console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${data.customers.length} –∫–ª–∏–µ–Ω—Ç–æ–≤`);
                    showAlert(`–£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ ${data.customers.length} –∫–ª–∏–µ–Ω—Ç–æ–≤`);
                } else {
                    // –í—Å–µ–≥–¥–∞ —Å–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
                    select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞ (—Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ)</option>';
                    const testCustomers = [
                        { id: 1, name: '–¢–µ—Å—Ç–æ–≤—ã–π –ö–ª–∏–µ–Ω—Ç 1', email: 'test1@example.com' },
                        { id: 2, name: '–¢–µ—Å—Ç–æ–≤—ã–π –ö–ª–∏–µ–Ω—Ç 2', email: 'test2@example.com' },
                        { id: 3, name: '–¢–µ—Å—Ç–æ–≤—ã–π –ö–ª–∏–µ–Ω—Ç 3', email: 'test3@example.com' }
                    ];

                    testCustomers.forEach(customer => {
                        const option = document.createElement('option');
                        option.value = customer.id;
                        option.textContent = `${customer.name} - ${customer.email}`;
                        select.appendChild(option);
                    });

                    console.log('‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–ª–∏–µ–Ω—Ç—ã');
                    showAlert('–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–æ–≤', 'error');
                }
            } catch (error) {
                console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:', error);

                // –ì–ê–†–ê–ù–¢–ò–†–û–í–ê–ù–ù–û —Å–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø—Ä–∏ –õ–Æ–ë–û–ô –æ—à–∏–±–∫–µ
                select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞ (—Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)</option>';
                const backupCustomers = [
                    { id: 1, name: '–†–µ–∑–µ—Ä–≤–Ω—ã–π –ö–ª–∏–µ–Ω—Ç 1', email: 'backup1@example.com' },
                    { id: 2, name: '–†–µ–∑–µ—Ä–≤–Ω—ã–π –ö–ª–∏–µ–Ω—Ç 2', email: 'backup2@example.com' },
                    { id: 3, name: '–†–µ–∑–µ—Ä–≤–Ω—ã–π –ö–ª–∏–µ–Ω—Ç 3', email: 'backup3@example.com' }
                ];

                backupCustomers.forEach(customer => {
                    const option = document.createElement('option');
                    option.value = customer.id;
                    option.textContent = `${customer.name} - ${customer.email}`;
                    select.appendChild(option);
                });

                showAlert('–ó–∞–≥—Ä—É–∂–µ–Ω—ã —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–æ–≤', 'error');
            } finally {
                loadBtn.innerHTML = originalText;
                loadBtn.disabled = false;
                console.log('üèÅ –ó–∞–≤–µ—Ä—à–µ–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤');
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞—Ç
        function initializeDates() {
            const today = new Date();
            const oneMonthAgo = new Date();
            oneMonthAgo.setDate(today.getDate() - 30);

            document.getElementById('start-date').value = oneMonthAgo.toISOString().split('T')[0];
            document.getElementById('end-date').value = today.toISOString().split('T')[0];
            document.getElementById('report-date').value = today.toISOString().split('T')[0];
        }

        // –í—ã–±–æ—Ä —Ç–∏–ø–∞ –æ—Ç—á–µ—Ç–∞
        function setupReportSelection() {
            document.querySelectorAll('.report-type').forEach(type => {
                type.addEventListener('click', function () {
                    // –°–±—Ä–æ—Å –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
                    document.querySelectorAll('.report-type').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');

                    currentReportType = this.dataset.report;
                    showReportParams(currentReportType);
                });
            });
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞
        function showReportParams(reportType) {
    console.log('üéØ –ü–æ–∫–∞–∑–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è:', reportType);
    
    // –°–Ω–∞—á–∞–ª–∞ —Å–∫—Ä—ã–≤–∞–µ–º –í–°–ï –±–ª–æ–∫–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    const allParamBlocks = document.querySelectorAll('[id$="-params"]');
    allParamBlocks.forEach(block => {
        block.style.display = 'none';
    });
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—â–∏–π –±–ª–æ–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    const commonParams = document.getElementById('common-params');
    if (commonParams) {
        commonParams.style.display = 'flex';
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    const paramsContainer = document.getElementById('report-params');
    paramsContainer.style.display = 'block';
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞
    const specificParams = document.getElementById(`${reportType}-params`);
    if (specificParams) {
        specificParams.style.display = 'flex';
        console.log('‚úÖ –ü–æ–∫–∞–∑–∞–Ω—ã –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è:', reportType);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø–æ—è–≤–ª–µ–Ω–∏—è
        specificParams.style.opacity = '0';
        specificParams.style.transition = 'opacity 0.3s ease-in-out';
        setTimeout(() => {
            specificParams.style.opacity = '1';
        }, 10);
    } else {
        console.warn('‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω –±–ª–æ–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –¥–ª—è:', reportType);
    }
    
    // –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç—á–µ—Ç–∞
    document.getElementById('generate-report').disabled = false;
    document.getElementById('export-excel').disabled = true;
    
    // –û—Å–æ–±—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö –æ—Ç—á–µ—Ç–æ–≤
    if (reportType === 'customer-orders') {
        console.log('üîÑ –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤...');
        // –î–∞–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É —á—Ç–æ–±—ã –±–ª–æ–∫ —É—Å–ø–µ–ª –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å—Å—è
        setTimeout(() => {
            loadCustomers();
        }, 100);
    }
    
    if (reportType === 'daily-revenue') {
        const today = new Date();
        document.getElementById('report-date').value = today.toISOString().split('T')[0];
    }
}

        // –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç
        async function generateReport() {
            if (!currentReportType) {
                showAlert('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ—Ç—á–µ—Ç–∞', 'error');
                return;
            }

            const generateBtn = document.getElementById('generate-report');
            const originalText = generateBtn.innerHTML;

            try {
                // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                generateBtn.innerHTML = '<div class="loading"></div> –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ...';
                generateBtn.disabled = true;

                const token = localStorage.getItem('token');
                let url = `/api/admin/reports/${currentReportType}`;
                const params = new URLSearchParams();

                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;

                if (startDate) params.append('startDate', startDate);
                if (endDate) params.append('endDate', endDate);

                // –î–æ–±–∞–≤–ª—è–µ–º —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
                if (currentReportType === 'daily-revenue') {
                    const reportDate = document.getElementById('report-date').value;
                    if (reportDate) params.append('date', reportDate);
                }

                if (currentReportType === 'average-check') {
                    const periodType = document.getElementById('period-type').value;
                    params.append('period', periodType);
                }

                if (currentReportType === 'customer-orders') {
                    const customerId = document.getElementById('customer-select').value;
                    if (!customerId) {
                        showAlert('–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ —Å–ø–∏—Å–∫–∞', 'error');
                        generateBtn.innerHTML = originalText;
                        generateBtn.disabled = false;
                        return;
                    }
                    params.append('customerId', customerId);
                }

                if (params.toString()) {
                    url += `?${params.toString()}`;
                }

                console.log('üåê –ó–∞–ø—Ä–æ—Å –∫ API:', url);

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç—á–µ—Ç–∞');

                const data = await response.json();
                console.log('üìà –î–∞–Ω–Ω—ã–µ –æ—Ç—á–µ—Ç–∞:', data);

                if (data.success) {
                    currentReportData = data;
                    displayReport(data, currentReportType);
                    showAlert('–û—Ç—á–µ—Ç —É—Å–ø–µ—à–Ω–æ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω');

                    // –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É —ç–∫—Å–ø–æ—Ä—Ç–∞
                    document.getElementById('export-excel').disabled = false;
                } else {
                    throw new Error(data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞:', error);
                showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –æ—Ç—á–µ—Ç–∞: ' + error.message, 'error');
            } finally {
                // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É
                generateBtn.innerHTML = originalText;
                generateBtn.disabled = false;
            }
        }

        // –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å –æ—Ç—á–µ—Ç
        function displayReport(data, reportType) {
            const resultsContainer = document.getElementById('report-results');

            switch (reportType) {
                case 'daily-revenue':
                    displayDailyRevenueReport(data, resultsContainer);
                    break;
                case 'average-check':
                    displayAverageCheckReport(data, resultsContainer);
                    break;
                case 'sales-dynamics':
                    displaySalesDynamicsReport(data, resultsContainer);
                    break;
                case 'order-performance':
                    displayOrderPerformanceReport(data, resultsContainer);
                    break;
                case 'customer-base':
                    displayCustomerBaseReport(data, resultsContainer);
                    break;
                case 'customer-orders':
                    displayCustomerOrdersReport(data, resultsContainer);
                    break;
                default:
                    resultsContainer.innerHTML = '<p>–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –æ—Ç—á–µ—Ç–∞</p>';
            }
        }

        // 1. –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç—á–µ—Ç –æ –≤—ã—Ä—É—á–∫–µ
        function displayDailyRevenueReport(data, container) {
            const report = data.report;
            let html = `
                <div class="report-summary">
                    <div class="summary-item">
                        –î–∞—Ç–∞ –æ—Ç—á–µ—Ç–∞: <span class="summary-value">${report.date}</span>
                    </div>
                    <div class="summary-item">
                        –í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤: <span class="summary-value">${report.summary.total_orders}</span>
                    </div>
                    <div class="summary-item">
                        –û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞: <span class="summary-value">${report.summary.total_revenue.toFixed(2)} —Ä—É–±.</span>
                    </div>
                    <div class="summary-item">
                        –°—Ä–µ–¥–Ω–∏–π —á–µ–∫: <span class="summary-value">${report.summary.average_order_value.toFixed(2)} —Ä—É–±.</span>
                    </div>
                </div>

                <h4>–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h4>
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                            <th>–í—ã—Ä—É—á–∫–∞</th>
                            <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥–∞–∂</th>
                            <th>–î–æ–ª—è –≤ –≤—ã—Ä—É—á–∫–µ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            report.category_details.forEach(category => {
                html += `
                    <tr>
                        <td><strong>${category.category}</strong></td>
                        <td>${category.revenue.toFixed(2)} —Ä—É–±.</td>
                        <td>${category.units} –µ–¥.</td>
                        <td>${(category.revenue / report.summary.total_revenue * 100).toFixed(1)}%</td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        // 2. –ê–Ω–∞–ª–∏–∑ —Å—Ä–µ–¥–Ω–µ–≥–æ —á–µ–∫–∞
        function displayAverageCheckReport(data, container) {
            let html = `
                <div class="kpi-container">
                    <div class="kpi-card">
                        <div class="kpi-label">–¢–µ–∫—É—â–∏–π –ø–µ—Ä–∏–æ–¥</div>
                        <div class="kpi-value">${data.summary.current_period_avg.toFixed(2)} —Ä—É–±.</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">–ü—Ä–µ–¥—ã–¥—É—â–∏–π –ø–µ—Ä–∏–æ–¥</div>
                        <div class="kpi-value">${data.summary.previous_period_avg.toFixed(2)} —Ä—É–±.</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">–û–±—â–∏–π —Å—Ä–µ–¥–Ω–∏–π</div>
                        <div class="kpi-value">${data.summary.overall_avg.toFixed(2)} —Ä—É–±.</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—Ä–∏–æ–¥–æ–≤</div>
                        <div class="kpi-value">${data.summary.total_periods}</div>
                    </div>
                </div>

                <h4>–î–∏–Ω–∞–º–∏–∫–∞ —Å—Ä–µ–¥–Ω–µ–≥–æ —á–µ–∫–∞</h4>
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>–ü–µ—Ä–∏–æ–¥</th>
                            <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤</th>
                            <th>–í—ã—Ä—É—á–∫–∞</th>
                            <th>–°—Ä–µ–¥–Ω–∏–π —á–µ–∫</th>
                            <th>–ò–∑–º–µ–Ω–µ–Ω–∏–µ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.report.forEach(row => {
                const trendIcon = row.trend === 'up' ? '‚ÜóÔ∏è' : row.trend === 'down' ? '‚ÜòÔ∏è' : '‚û°Ô∏è';
                const trendClass = row.trend === 'up' ? 'percentage-up' : row.trend === 'down' ? 'percentage-down' : '';

                html += `
                    <tr>
                        <td>${row.period}</td>
                        <td>${row.order_count}</td>
                        <td>${row.total_revenue.toFixed(2)} —Ä—É–±.</td>
                        <td>${row.average_check.toFixed(2)} —Ä—É–±.</td>
                        <td>
                            ${trendIcon}
                            <span class="percentage-badge ${trendClass}">
                                ${row.change_percentage}%
                            </span>
                        </td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        // 3. –î–∏–Ω–∞–º–∏–∫–∞ –ø—Ä–æ–¥–∞–∂
        function displaySalesDynamicsReport(data, container) {
            let html = `
                <div class="report-summary">
                    <div class="summary-item">
                        –ü–µ—Ä–∏–æ–¥: ${data.summary.period.startDate || '–≤—Å–µ –≤—Ä–µ–º—è'} - ${data.summary.period.endDate || '–≤—Å–µ –≤—Ä–µ–º—è'}
                    </div>
                    <div class="summary-item">
                        –í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤: <span class="summary-value">${data.summary.total_orders}</span>
                    </div>
                    <div class="summary-item">
                        –û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞: <span class="summary-value">${data.summary.total_revenue.toFixed(2)} —Ä—É–±.</span>
                    </div>
                    <div class="summary-item">
                        –°—Ä–µ–¥–Ω–µ–µ –∑–∞–∫–∞–∑–æ–≤ –≤ –¥–µ–Ω—å: <span class="summary-value">${data.summary.average_daily_orders}</span>
                    </div>
                </div>

                <h4>–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–Ω—è–º</h4>
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>–î–∞—Ç–∞</th>
                            <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤</th>
                            <th>–í—ã—Ä—É—á–∫–∞</th>
                            <th>–°—Ä–µ–¥–Ω–∏–π —á–µ–∫</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.report.forEach(row => {
                const isPeak = data.summary.peak_period && row.date === data.summary.peak_period.date;
                const rowStyle = isPeak ? 'style="background-color: #fff3cd;"' : '';

                html += `
                    <tr ${rowStyle}>
                        <td>${row.date} ${isPeak ? 'üèÜ' : ''}</td>
                        <td>${row.order_count}</td>
                        <td>${row.total_revenue.toFixed(2)} —Ä—É–±.</td>
                        <td>${row.average_order_value.toFixed(2)} —Ä—É–±.</td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        // 4. –û—Ç—á–µ—Ç –ø–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º –∑–∞–∫–∞–∑–∞–º
        function displayOrderPerformanceReport(data, container) {
            const report = data.report;
            let html = `
                <div class="kpi-container">
                    <div class="kpi-card">
                        <div class="kpi-label">–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</div>
                        <div class="kpi-value">${report.totals.total_orders}</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
                        <div class="kpi-value">${report.totals.completed_orders}</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">–ü—Ä–æ—Ü–µ–Ω—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</div>
                        <div class="kpi-value">${report.totals.completion_rate}%</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">–û—Ç–º–µ–Ω–µ–Ω–æ</div>
                        <div class="kpi-value">${report.totals.cancelled_orders}</div>
                    </div>
                </div>

                <h4>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º</h4>
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                            <th>–î–æ–ª—è</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            report.status_breakdown.forEach(status => {
                const percentage = (status.count / report.totals.total_orders * 100).toFixed(1);
                html += `
                    <tr>
                        <td>${getStatusName(status.status)}</td>
                        <td>${status.count}</td>
                        <td>${percentage}%</td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        // 5. –ë–∞–∑–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤
        function displayCustomerBaseReport(data, container) {
            const report = data.report;
            let html = `
                <div class="kpi-container">
                    <div class="kpi-card">
                        <div class="kpi-label">–í—Å–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–æ–≤</div>
                        <div class="kpi-value">${report.customer_stats.total_customers}</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">–ù–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤</div>
                        <div class="kpi-value">${report.customer_stats.new_customers}</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤</div>
                        <div class="kpi-value">${report.customer_stats.active_customers}</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">–£—Ä–æ–≤–µ–Ω—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</div>
                        <div class="kpi-value">${report.activity_rate}%</div>
                    </div>
                </div>
            `;

            // –î–µ—Ç–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤
            if (report.customers_list && report.customers_list.length > 0) {
                html += `
                    <h4>–î–µ—Ç–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤</h4>
                    <div style="overflow-x: auto;">
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>–§–ò–û</th>
                                    <th>Email</th>
                                    <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                                    <th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th>
                                    <th>–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</th>
                                    <th>–û–±—â–∞—è —Å—É–º–º–∞</th>
                                    <th>–°—Ç–∞—Ç—É—Å</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                report.customers_list.forEach(customer => {
                    const fullName = `${customer.first_name || ''} ${customer.last_name || ''}`.trim() || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
                    const registrationDate = new Date(customer.registration_date).toLocaleDateString('ru-RU');
                    const totalSpent = parseFloat(customer.total_spent).toFixed(2);
                    const statusClass = customer.status === '–ê–∫—Ç–∏–≤–Ω—ã–π' ? 'percentage-up' : '';

                    html += `
                        <tr>
                            <td>${customer.id}</td>
                            <td><strong>${fullName}</strong></td>
                            <td>${customer.email}</td>
                            <td>${customer.phone || '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
                            <td>${registrationDate}</td>
                            <td>${customer.total_orders}</td>
                            <td>${totalSpent} —Ä—É–±.</td>
                            <td><span class="percentage-badge ${statusClass}">${customer.status}</span></td>
                        </tr>
                    `;
                });

                html += `</tbody></table></div>`;
            }

            // –ì–µ–æ–≥—Ä–∞—Ñ–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤
            html += `<h4 style="margin-top: 30px;">–ì–µ–æ–≥—Ä–∞—Ñ–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤</h4>`;

            if (report.geography && report.geography.length > 0) {
                html += `
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>–†–µ–≥–∏–æ–Ω</th>
                                <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª–∏–µ–Ω—Ç–æ–≤</th>
                                <th>–î–æ–ª—è</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                report.geography.forEach(region => {
                    const percentage = report.customer_stats.total_customers > 0 ?
                        (region.customers / report.customer_stats.total_customers * 100).toFixed(1) : 0;
                    html += `
                        <tr>
                            <td>${region.region}</td>
                            <td>${region.customers}</td>
                            <td>${percentage}%</td>
                        </tr>
                    `;
                });

                html += `</tbody></table>`;
            } else {
                html += `<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –≥–µ–æ–≥—Ä–∞—Ñ–∏–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤</p>`;
            }

            container.innerHTML = html;
        }

        // 6. –ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤ –∫–ª–∏–µ–Ω—Ç–æ–≤
        function displayCustomerOrdersReport(data, container) {
            const report = data.report;
            if (!report.customer_info) {
                container.innerHTML = '<p>–ö–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –∑–∞–∫–∞–∑–∞—Ö</p>';
                return;
            }

            let html = `
                <div class="report-summary">
                    <div class="summary-item">
                        –ö–ª–∏–µ–Ω—Ç: <span class="summary-value">${report.customer_info.name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</span>
                    </div>
                    <div class="summary-item">
                        Email: <span class="summary-value">${report.customer_info.email}</span>
                    </div>
                    <div class="summary-item">
                        –¢–µ–ª–µ—Ñ–æ–Ω: <span class="summary-value">${report.customer_info.phone || '–ù–µ —É–∫–∞–∑–∞–Ω'}</span>
                    </div>
                </div>

                <div class="kpi-container">
                    <div class="kpi-card">
                        <div class="kpi-label">–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</div>
                        <div class="kpi-value">${report.analytics.total_orders}</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">–û–±—â–∞—è —Å—É–º–º–∞</div>
                        <div class="kpi-value">${report.analytics.total_spent.toFixed(2)} —Ä—É–±.</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">–°—Ä–µ–¥–Ω–∏–π —á–µ–∫</div>
                        <div class="kpi-value">${report.analytics.average_order_value.toFixed(2)} —Ä—É–±.</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">–õ—é–±–∏–º–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è</div>
                        <div class="kpi-value">${report.analytics.favorite_category}</div>
                    </div>
                </div>
            `;

            // –ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤
            html += `<h4>–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</h4>`;

            if (report.orders && report.orders.length > 0) {
                html += `
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>ID –∑–∞–∫–∞–∑–∞</th>
                                <th>–î–∞—Ç–∞</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–°—É–º–º–∞</th>
                                <th>–¢–æ–≤–∞—Ä—ã</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                report.orders.forEach(order => {
                    let itemsList = '';
                    try {
                        if (typeof order.items === 'string') {
                            const items = JSON.parse(order.items);
                            itemsList = items.map(item =>
                                `${item.name} (${item.quantity} —à—Ç.)`
                            ).join(', ');
                        } else if (Array.isArray(order.items)) {
                            itemsList = order.items.map(item =>
                                `${item.name} (${item.quantity} —à—Ç.)`
                            ).join(', ');
                        }
                    } catch (e) {
                        itemsList = '–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Ç–æ–≤–∞—Ä–æ–≤';
                    }

                    html += `
                        <tr>
                            <td>#${order.id}</td>
                            <td>${new Date(order.created_at).toLocaleDateString('ru-RU')}</td>
                            <td>${getStatusName(order.status)}</td>
                            <td>${order.total_price} —Ä—É–±.</td>
                            <td title="${itemsList}">${itemsList.substring(0, 50)}${itemsList.length > 50 ? '...' : ''}</td>
                        </tr>
                    `;
                });

                html += `</tbody></table>`;
            } else {
                html += `<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –∑–∞–∫–∞–∑–∞—Ö</p>`;
            }

            container.innerHTML = html;
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function getStatusName(status) {
            const statusNames = {
                'new': '–ù–æ–≤—ã–π',
                'processing': '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ',
                'delivered': '–î–æ—Å—Ç–∞–≤–ª–µ–Ω',
                'cancelled': '–û—Ç–º–µ–Ω–µ–Ω'
            };
            return statusNames[status] || status;
        }

        // –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
       // –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel - –ü–û–õ–ù–ê–Ø –í–ï–†–°–ò–Ø –î–õ–Ø –í–°–ï–• –û–¢–ß–ï–¢–û–í
function exportToExcel() {
    if (!currentReportData) {
        showAlert('–°–Ω–∞—á–∞–ª–∞ —Å—Ñ–æ—Ä–º–∏—Ä—É–π—Ç–µ –æ—Ç—á–µ—Ç', 'error');
        return;
    }
    
    // –°–æ–∑–¥–∞–µ–º HTML —Ç–∞–±–ª–∏—Ü—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ Excel
    let htmlContent = `
        <html xmlns:o="urn:schemas-microsoft-com:office:office" 
              xmlns:x="urn:schemas-microsoft-com:office:excel" 
              xmlns="http://www.w3.org/TR/REC-html40">
        <head>
            <meta charset="UTF-8">
            <!--[if gte mso 9]>
            <xml>
                <x:ExcelWorkbook>
                    <x:ExcelWorksheets>
                        <x:ExcelWorksheet>
                            <x:Name>–û—Ç—á–µ—Ç</x:Name>
                            <x:WorksheetOptions>
                                <x:DisplayGridlines/>
                            </x:WorksheetOptions>
                        </x:ExcelWorksheet>
                    </x:ExcelWorksheets>
                </x:ExcelWorkbook>
            </xml>
            <![endif]-->
            <style>
                table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
                th { background-color: #f2f2f2; font-weight: bold; text-align: center; }
                td, th { border: 1px solid #ddd; padding: 8px; }
                .summary { background-color: #e8f5e8; font-weight: bold; }
                .kpi-card { border: 1px solid #ddd; padding: 10px; margin: 5px; text-align: center; }
                h2 { color: #2c1a00; }
                h3 { color: #2c1a00; margin-top: 20px; }
            </style>
        </head>
        <body>
    `;
    
    let filename = '';
    let tableContent = '';
    
    switch (currentReportType) {
        case 'daily-revenue':
            filename = `daily_revenue_${new Date().toISOString().split('T')[0]}.xls`;
            tableContent = `
                <h2>–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç—á–µ—Ç –æ –≤—ã—Ä—É—á–∫–µ - ${currentReportData.report.date}</h2>
                <table>
                    <tr class="summary">
                        <td>–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</td>
                        <td>${currentReportData.report.summary.total_orders}</td>
                        <td>–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞</td>
                        <td>${currentReportData.report.summary.total_revenue.toFixed(2)} —Ä—É–±.</td>
                        <td>–°—Ä–µ–¥–Ω–∏–π —á–µ–∫</td>
                        <td>${currentReportData.report.summary.average_order_value.toFixed(2)} —Ä—É–±.</td>
                    </tr>
                </table>
                <br>
                <h3>–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h3>
                <table>
                    <tr>
                        <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                        <th>–í—ã—Ä—É—á–∫–∞</th>
                        <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥–∞–∂</th>
                        <th>–î–æ–ª—è –≤ –≤—ã—Ä—É—á–∫–µ</th>
                    </tr>
            `;
            currentReportData.report.category_details.forEach(category => {
                tableContent += `
                    <tr>
                        <td>${category.category}</td>
                        <td>${category.revenue.toFixed(2)} —Ä—É–±.</td>
                        <td>${category.units} –µ–¥.</td>
                        <td>${(category.revenue / currentReportData.report.summary.total_revenue * 100).toFixed(1)}%</td>
                    </tr>
                `;
            });
            tableContent += '</table>';
            break;
            
        case 'average-check':
            filename = `average_check_${new Date().toISOString().split('T')[0]}.xls`;
            tableContent = `
                <h2>–ê–Ω–∞–ª–∏–∑ —Å—Ä–µ–¥–Ω–µ–≥–æ —á–µ–∫–∞</h2>
                <table>
                    <tr class="summary">
                        <td>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—Ä–∏–æ–¥–æ–≤</td>
                        <td>${currentReportData.summary.total_periods}</td>
                        <td>–¢–µ–∫—É—â–∏–π –ø–µ—Ä–∏–æ–¥</td>
                        <td>${currentReportData.summary.current_period_avg.toFixed(2)} —Ä—É–±.</td>
                        <td>–ü—Ä–µ–¥—ã–¥—É—â–∏–π –ø–µ—Ä–∏–æ–¥</td>
                        <td>${currentReportData.summary.previous_period_avg.toFixed(2)} —Ä—É–±.</td>
                    </tr>
                </table>
                <br>
                <h3>–î–∏–Ω–∞–º–∏–∫–∞ —Å—Ä–µ–¥–Ω–µ–≥–æ —á–µ–∫–∞</h3>
                <table>
                    <tr>
                        <th>–ü–µ—Ä–∏–æ–¥</th>
                        <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤</th>
                        <th>–í—ã—Ä—É—á–∫–∞</th>
                        <th>–°—Ä–µ–¥–Ω–∏–π —á–µ–∫</th>
                        <th>–ò–∑–º–µ–Ω–µ–Ω–∏–µ</th>
                    </tr>
            `;
            
            currentReportData.report.forEach(row => {
                const trendIcon = row.trend === 'up' ? '‚ÜóÔ∏è' : row.trend === 'down' ? '‚ÜòÔ∏è' : '‚û°Ô∏è';
                tableContent += `
                    <tr>
                        <td>${row.period}</td>
                        <td>${row.order_count}</td>
                        <td>${row.total_revenue.toFixed(2)} —Ä—É–±.</td>
                        <td>${row.average_check.toFixed(2)} —Ä—É–±.</td>
                        <td>${trendIcon} ${row.change_percentage}%</td>
                    </tr>
                `;
            });
            tableContent += '</table>';
            break;
            
        case 'sales-dynamics':
            filename = `sales_dynamics_${new Date().toISOString().split('T')[0]}.xls`;
            tableContent = `
                <h2>–î–∏–Ω–∞–º–∏–∫–∞ –ø—Ä–æ–¥–∞–∂</h2>
                <table>
                    <tr class="summary">
                        <td>–ü–µ—Ä–∏–æ–¥</td>
                        <td>${currentReportData.summary.period.startDate || '–≤—Å–µ –≤—Ä–µ–º—è'} - ${currentReportData.summary.period.endDate || '–≤—Å–µ –≤—Ä–µ–º—è'}</td>
                        <td>–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</td>
                        <td>${currentReportData.summary.total_orders}</td>
                        <td>–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞</td>
                        <td>${currentReportData.summary.total_revenue.toFixed(2)} —Ä—É–±.</td>
                    </tr>
                </table>
                <br>
                <h3>–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–Ω—è–º</h3>
                <table>
                    <tr>
                        <th>–î–∞—Ç–∞</th>
                        <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤</th>
                        <th>–í—ã—Ä—É—á–∫–∞</th>
                        <th>–°—Ä–µ–¥–Ω–∏–π —á–µ–∫</th>
                    </tr>
            `;
            currentReportData.report.forEach(row => {
                tableContent += `
                    <tr>
                        <td>${row.date}</td>
                        <td>${row.order_count}</td>
                        <td>${row.total_revenue.toFixed(2)} —Ä—É–±.</td>
                        <td>${row.average_order_value.toFixed(2)} —Ä—É–±.</td>
                    </tr>
                `;
            });
            tableContent += '</table>';
            break;
            
        case 'order-performance':
            filename = `order_performance_${new Date().toISOString().split('T')[0]}.xls`;
            tableContent = `
                <h2>–û—Ç—á–µ—Ç –ø–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º –∑–∞–∫–∞–∑–∞–º</h2>
                <table>
                    <tr class="summary">
                        <td>–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</td>
                        <td>${currentReportData.report.totals.total_orders}</td>
                        <td>–í—ã–ø–æ–ª–Ω–µ–Ω–æ</td>
                        <td>${currentReportData.report.totals.completed_orders}</td>
                        <td>–ü—Ä–æ—Ü–µ–Ω—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</td>
                        <td>${currentReportData.report.totals.completion_rate}%</td>
                    </tr>
                </table>
                <br>
                <h3>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º</h3>
                <table>
                    <tr>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                        <th>–î–æ–ª—è</th>
                    </tr>
            `;
            currentReportData.report.status_breakdown.forEach(status => {
                const percentage = (status.count / currentReportData.report.totals.total_orders * 100).toFixed(1);
                tableContent += `
                    <tr>
                        <td>${getStatusName(status.status)}</td>
                        <td>${status.count}</td>
                        <td>${percentage}%</td>
                    </tr>
                `;
            });
            tableContent += '</table>';
            break;
            
        case 'customer-base':
            filename = `customer_base_${new Date().toISOString().split('T')[0]}.xls`;
            tableContent = `
                <h2>–ë–∞–∑–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤</h2>
                <table>
                    <tr class="summary">
                        <td>–í—Å–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–æ–≤</td>
                        <td>${currentReportData.report.customer_stats.total_customers}</td>
                        <td>–ù–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤</td>
                        <td>${currentReportData.report.customer_stats.new_customers}</td>
                        <td>–ê–∫—Ç–∏–≤–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤</td>
                        <td>${currentReportData.report.customer_stats.active_customers}</td>
                    </tr>
                </table>
                <br>
                <h3>–î–µ—Ç–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤</h3>
                <table>
                    <tr>
                        <th>ID</th>
                        <th>–§–ò–û</th>
                        <th>Email</th>
                        <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                        <th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th>
                        <th>–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</th>
                        <th>–û–±—â–∞—è —Å—É–º–º–∞</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                    </tr>
            `;
            
            if (currentReportData.report.customers_list && currentReportData.report.customers_list.length > 0) {
                currentReportData.report.customers_list.forEach(customer => {
                    const fullName = `${customer.first_name || ''} ${customer.last_name || ''}`.trim() || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
                    const registrationDate = new Date(customer.registration_date).toLocaleDateString('ru-RU');
                    const totalSpent = parseFloat(customer.total_spent).toFixed(2);
                    
                    tableContent += `
                        <tr>
                            <td>${customer.id}</td>
                            <td>${fullName}</td>
                            <td>${customer.email}</td>
                            <td>${customer.phone || '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
                            <td>${registrationDate}</td>
                            <td>${customer.total_orders}</td>
                            <td>${totalSpent} —Ä—É–±.</td>
                            <td>${customer.status}</td>
                        </tr>
                    `;
                });
            }
            
            tableContent += '</table>';
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≥–µ–æ–≥—Ä–∞—Ñ–∏—é –≤ —ç–∫—Å–ø–æ—Ä—Ç
            if (currentReportData.report.geography && currentReportData.report.geography.length > 0) {
                tableContent += `
                    <br>
                    <h3>–ì–µ–æ–≥—Ä–∞—Ñ–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤</h3>
                    <table>
                        <tr>
                            <th>–†–µ–≥–∏–æ–Ω</th>
                            <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª–∏–µ–Ω—Ç–æ–≤</th>
                            <th>–î–æ–ª—è</th>
                        </tr>
                `;
                
                currentReportData.report.geography.forEach(region => {
                    const percentage = currentReportData.report.customer_stats.total_customers > 0 ? 
                        (region.customers / currentReportData.report.customer_stats.total_customers * 100).toFixed(1) : 0;
                    tableContent += `
                        <tr>
                            <td>${region.region}</td>
                            <td>${region.customers}</td>
                            <td>${percentage}%</td>
                        </tr>
                    `;
                });
                
                tableContent += '</table>';
            }
            break;
            
        case 'customer-orders':
            filename = `customer_orders_${new Date().toISOString().split('T')[0]}.xls`;
            tableContent = `
                <h2>–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤ –∫–ª–∏–µ–Ω—Ç–∞</h2>
                <table>
                    <tr class="summary">
                        <td>–ö–ª–∏–µ–Ω—Ç</td>
                        <td>${currentReportData.report.customer_info.name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</td>
                        <td>Email</td>
                        <td>${currentReportData.report.customer_info.email}</td>
                        <td>–¢–µ–ª–µ—Ñ–æ–Ω</td>
                        <td>${currentReportData.report.customer_info.phone || '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
                    </tr>
                </table>
                <br>
                <table>
                    <tr class="summary">
                        <td>–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</td>
                        <td>${currentReportData.report.analytics.total_orders}</td>
                        <td>–û–±—â–∞—è —Å—É–º–º–∞</td>
                        <td>${currentReportData.report.analytics.total_spent.toFixed(2)} —Ä—É–±.</td>
                        <td>–°—Ä–µ–¥–Ω–∏–π —á–µ–∫</td>
                        <td>${currentReportData.report.analytics.average_order_value.toFixed(2)} —Ä—É–±.</td>
                    </tr>
                </table>
            `;
            
            if (Object.keys(currentReportData.report.analytics.category_preferences || {}).length > 0) {
                tableContent += `
                    <br>
                    <h3>–ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h3>
                    <table>
                        <tr>
                            <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                            <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤</th>
                        </tr>
                `;
                
                Object.entries(currentReportData.report.analytics.category_preferences).forEach(([category, count]) => {
                    tableContent += `
                        <tr>
                            <td>${category}</td>
                            <td>${count}</td>
                        </tr>
                    `;
                });
                
                tableContent += '</table>';
            }
            
            tableContent += `
                <br>
                <h3>–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</h3>
                <table>
                    <tr>
                        <th>ID –∑–∞–∫–∞–∑–∞</th>
                        <th>–î–∞—Ç–∞</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–°—É–º–º–∞</th>
                        <th>–¢–æ–≤–∞—Ä—ã</th>
                    </tr>
            `;
            
            if (currentReportData.report.orders && currentReportData.report.orders.length > 0) {
                currentReportData.report.orders.forEach(order => {
                    let itemsList = '';
                    try {
                        if (typeof order.items === 'string') {
                            const items = JSON.parse(order.items);
                            itemsList = items.map(item => 
                                `${item.name} (${item.quantity} —à—Ç.)`
                            ).join('; ');
                        } else if (Array.isArray(order.items)) {
                            itemsList = order.items.map(item => 
                                `${item.name} (${item.quantity} —à—Ç.)`
                            ).join('; ');
                        }
                    } catch (e) {
                        itemsList = '–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Ç–æ–≤–∞—Ä–æ–≤';
                    }
                    
                    tableContent += `
                        <tr>
                            <td>${order.id}</td>
                            <td>${new Date(order.created_at).toLocaleDateString('ru-RU')}</td>
                            <td>${getStatusName(order.status)}</td>
                            <td>${order.total_price} —Ä—É–±.</td>
                            <td>${itemsList}</td>
                        </tr>
                    `;
                });
            }
            
            tableContent += '</table>';
            break;
            
        default:
            showAlert('–≠–∫—Å–ø–æ—Ä—Ç –≤ Excel –¥–ª—è —ç—Ç–æ–≥–æ —Ç–∏–ø–∞ –æ—Ç—á–µ—Ç–∞ –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω', 'error');
            return;
    }
    
    htmlContent += tableContent + '</body></html>';
    
    downloadFile(htmlContent, filename, 'application/vnd.ms-excel');
    showAlert('–û—Ç—á–µ—Ç —É—Å–ø–µ—à–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –≤ Excel');
}

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/';
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function () {
            if (checkAuth()) {
                initializeDates();
                setupReportSelection();

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                document.getElementById('generate-report').addEventListener('click', generateReport);
                document.getElementById('export-excel').addEventListener('click', exportToExcel);
                document.getElementById('load-customers-btn').addEventListener('click', loadCustomers);

                document.getElementById('refresh-reports').addEventListener('click', function () {
                    if (currentReportData) {
                        generateReport();
                    }
                });

                document.getElementById('logout-btn').addEventListener('click', function (e) {
                    e.preventDefault();
                    logout();
                });

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
                document.getElementById('export-all').addEventListener('click', function (e) {
                    e.preventDefault();
                    showAlert('–§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'error');
                });

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                document.getElementById('create-test-users').addEventListener('click', function (e) {
                    e.preventDefault();
                    showAlert('–§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'error');
                });

                console.log('‚úÖ –°–∏—Å—Ç–µ–º–∞ –æ—Ç—á–µ—Ç–æ–≤ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
            }
        });
    </script>
</body>

</html>